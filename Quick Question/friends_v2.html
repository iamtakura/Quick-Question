<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friends Mode - Quick Question</title>
    <link rel="stylesheet" href="friends_style.css">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <a href="index.html" class="home-logo">QUICK QUESTION</a>
        <nav>
            <div class="nav-container">
                <a href="game.html" class="nav-item">Strangers</a>
                <a href="friends.html" class="nav-item active">Friends</a>
                <a href="truth-dare.html" class="nav-item">Truth OR Dare</a>
                <a href="dating.html" class="nav-item">Dating</a>
                <a href="relationship.html" class="nav-item">Relationship</a>
            </div>
        </nav>
    </header>

    <div class="game-container">
        <div class="card" id="question-card">
            <div class="card-face card-front">
                <p id="question-text">Loading questions...</p>
            </div>
        </div>

        <div class="controls">
            <button id="next-btn">Next Question â†’</button>
            <div class="counter">Question <span id="current-q">1</span>/10</div>
        </div>
    </div>
    <div class="chat-container">
        <div class="chat-box" id="chat-box">
            <!-- Messages will appear here -->
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Type your message...">
            <button id="send-btn">Send</button>
        </div>
    </div>

    <script type="module">
        // Content from friends_script.js (excluding chat)
        import { database, ref, push, set, onValue, update } from './firebase.js'; // Assuming firebase.js is accessible
        let currentRoom = {}; // Track room state

        // DOM Elements (ensure these don't conflict with chat script variables if names are identical)
        const questionElement = document.getElementById('question-text');
        const nextButton = document.getElementById('next-btn');

        const friendsQuestions = [
            "What's the most embarrassing thing that's happened to you?",
            "If we were roommates, what would annoy you most about me?",
            "If I was to get dumped, what would you do to comfort me?",
            "What's your favorite memory of our friendship?",
            "If you could change one thing about me, what would it be?",
            "What's something you think I'm secretly good at?",
            "What's the weirdest habit I have that you've noticed?",
            "If we switched lives for a day, what would surprise you most?",
            "What's something you think I don't know about you?",
            "Where do you see our friendship in 5 years?"
        ];

        function initGameLogic() {
            console.log("Friends mode game logic initialized");
            if (questionElement && friendsQuestions.length > 0) {
                questionElement.textContent = friendsQuestions[0];
                const currentQCounter = document.getElementById('current-q');
                if (currentQCounter) {
                    // Assuming the counter shows total questions from the array
                    currentQCounter.textContent = `1/${friendsQuestions.length}`;
                }
            }
            if (nextButton) {
                let currentQuestionIndex = 0;
                nextButton.addEventListener('click', () => {
                    currentQuestionIndex = (currentQuestionIndex + 1) % friendsQuestions.length;
                    if (questionElement) {
                        questionElement.textContent = friendsQuestions[currentQuestionIndex];
                    }
                    const currentQCounter = document.getElementById('current-q');
                    if (currentQCounter) {
                        currentQCounter.textContent = `${currentQuestionIndex + 1}/${friendsQuestions.length}`;
                    }
                    console.log("Next question loaded by friends_script game logic.");
                });
            }
        }

        // Start the game logic
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGameLogic);
        } else {
            initGameLogic();
        }
    </script>

    <script>
        // Server-based chat script (from game_v2.html)
        // Configuration for testing - manually change for different users/sessions
        // Example for User A:
        // const sessionId = "friendsSession456";
        // const sender = "FriendA";

        // Example for User B (in a separate browser tab/window after changing):
        const sessionId = "friendsSession456"; // Should be the same as User A's
        const sender = "FriendB";               // Should be different from User A

        // --- End of Manual Configuration Area ---

        const chatBox = document.getElementById('chat-box');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-btn');

        function fetchMessages() {
            if (!chatBox) {
                console.error("Chat box element not found for server chat.");
                return;
            }
            fetch(`get-messages.php?session_id=${sessionId}`)
                .then(res => {
                    if (!res.ok) {
                        return res.text().then(text => {
                           throw new Error(`HTTP error! status: ${res.status}, body: ${text}`);
                        });
                    }
                    const contentType = res.headers.get("content-type");
                    if (contentType && contentType.indexOf("application/json") !== -1) {
                        return res.json();
                    } else {
                        return res.text().then(text => {
                            throw new Error(`Expected JSON, but received ${contentType}. Body: ${text}`);
                        });
                    }
                })
                .then(data => {
                    chatBox.innerHTML = '';
                    if (Array.isArray(data)) {
                        data.forEach(msg => {
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('msg');
                            const senderElement = document.createElement('b');
                            senderElement.textContent = (msg.sender || 'Unknown') + ': ';
                            messageElement.appendChild(senderElement);
                            messageElement.appendChild(document.createTextNode(msg.message || ''));
                            chatBox.appendChild(messageElement);
                        });
                    } else if (data) {
                        console.warn("Received non-array data from fetchMessages:", data);
                    }
                    chatBox.scrollTop = chatBox.scrollHeight;
                })
                .catch(error => {
                    console.error('Error fetching messages:', error);
                    const errorElement = document.createElement('div');
                    errorElement.classList.add('msg', 'error');
                    errorElement.textContent = 'Error loading messages. Check console for details.';
                    if (chatBox) chatBox.appendChild(errorElement);
                    if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
                });
        }

        function sendMessage() {
            if (!chatInput) {
                console.error("Chat input element not found for server chat.");
                return;
            }
            const msg = chatInput.value.trim();
            if (msg === '') return;

            fetch('send-message.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `session_id=${sessionId}&sender=${sender}&message=${encodeURIComponent(msg)}`
            })
            .then(response => {
                if (response.ok) {
                    chatInput.value = '';
                    fetchMessages();
                } else {
                    response.text().then(text => {
                        console.error('Error sending message:', response.status, response.statusText, text);
                        alert(`Error sending message: ${response.statusText} - ${text}`);
                    });
                }
            })
            .catch(error => {
                console.error('Network error or exception sending message:', error);
                alert('Network error sending message: ' + error.message);
            });
        }

        function initServerChat() {
            if (sendButton && chatInput && chatBox) {
                sendButton.addEventListener('click', sendMessage);
                chatInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                const messagePollingInterval = 1500;
                setInterval(fetchMessages, messagePollingInterval);
                fetchMessages();
            } else {
                console.error('Critical chat UI elements (chat-box, chat-input, or send-btn) not found. Server chat functionality will be disabled.');
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'Chat components failed to load for server chat. Please refresh or contact support.';
                errorDiv.style.color = 'red';
                errorDiv.style.backgroundColor = 'white';
                errorDiv.style.padding = '10px';
                errorDiv.style.textAlign = 'center';
                errorDiv.style.position = 'fixed';
                errorDiv.style.bottom = '0';
                errorDiv.style.width = '100%';
                errorDiv.style.zIndex = '1000';
                if(document.body) document.body.appendChild(errorDiv); else console.error("document.body not found for error message for server chat.");
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initServerChat);
        } else {
            initServerChat();
        }
    </script>
</body>
</html>
